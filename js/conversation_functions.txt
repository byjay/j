// ==========================================
// 2. ?곹깭 愿由?諛?珥덇린??
// ==========================================
let currentConversationCategory = '';
let currentConversationIndex = 0;

function initConversation() {
    const keys = Object.keys(conversationModuleData);
    if (keys.length > 0) currentConversationCategory = keys;
    renderNavigation();
    openConversationLesson(currentConversationCategory);
}

function renderNavigation() {
    const container = document.getElementById('conversation-content');
    if (!container) return;

    // Sticky Nav
    const navWrapper = document.createElement('div');
    navWrapper.className = 'sticky-nav-container';
    navWrapper.innerHTML = `
        <div class="flex items-center justify-between px-4 mb-2 w-full max-w-4xl mx-auto">
            <div class="flex-1 overflow-x-auto no-scrollbar flex gap-2" id="category-scroll-area">
                ${Object.entries(conversationModuleData).map(([key, data]) => `
                    <button onclick="openConversationLesson('${key}')" id="nav-btn-${key}"
                        class="flex-shrink-0 flex items-center gap-2 px-3 py-2 rounded-full border transition-all duration-300 active:scale-95 bg-white border-gray-200 text-gray-500 hover:bg-gray-50 text-sm shadow-sm">
                        <i class="${data.icon}"></i><span class="font-bold whitespace-nowrap">${data.title}</span>
                    </button>
                `).join('')}
            </div>
        </div>`;

    const viewerDiv = document.createElement('div');
    viewerDiv.id = 'conversation-viewer';
    viewerDiv.className = 'w-full max-w-4xl mx-auto px-4 pb-24';

    container.innerHTML = '';
    container.appendChild(navWrapper);
    container.appendChild(viewerDiv);
}

function openConversationLesson(key) {
    currentConversationCategory = key;
    currentConversationIndex = 0;
    AudioController.stopAutoRepeat(); // 移댄뀒怨좊━ 蹂寃????먮룞?ъ깮 以묐떒
    updateNavigationStyles(key);
    displayCurrentConversation();
}

function updateNavigationStyles(activeKey) {
    Object.keys(conversationModuleData).forEach(key => {
        const btn = document.getElementById(`nav-btn-${key}`);
        if(btn) btn.className = `flex-shrink-0 flex items-center gap-2 px-3 py-2 rounded-full border transition-all duration-300 bg-white border-gray-200 text-gray-500 hover:bg-gray-50 text-sm shadow-sm`;
    });
    const activeBtn = document.getElementById(`nav-btn-${activeKey}`);
    const color = conversationModuleData[activeKey].color;
    if(activeBtn) {
        activeBtn.className = `flex-shrink-0 flex items-center gap-2 px-4 py-2 rounded-full border-2 transition-all duration-300 scale-105 bg-${color}-50 border-${color}-500 text-${color}-600 shadow-md text-sm font-bold`;
        activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }
}

// ==========================================
// 3. ?뚮뜑留??붿쭊
// ==========================================
function createFlipCardHTML(data, type, index, color) {
    const isQuestion = type === 'question';
    const uniqueId = isQuestion? 'card-q' : `card-a-${index}`;

    // ?⑥뼱??HTML
    const vocabListHTML = data.vocab && data.vocab.length > 0
       ? `<div class="h-full flex flex-col">
            <div class="flex items-center gap-2 border-b border-gray-200 pb-3 mb-3">
                <i class="fas fa-book-reader text-${color}-500"></i>
                <span class="text-xs font-black text-gray-400 uppercase tracking-widest">Vocabulary</span>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar pr-1">
                <div class="vocab-grid">
                    ${data.vocab.map(v => `
                        <div class="vocab-item bg-white p-3 rounded-xl border border-gray-100 shadow-sm hover:shadow-md hover:border-${color}-200 cursor-default">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-lg font-bold text-gray-800 leading-tight">${v.word}</span>
                                ${v.type? `<span class="text-[10px] bg-${color}-50 text-${color}-600 px-1.5 py-0.5 rounded font-bold uppercase tracking-wider ml-1 whitespace-nowrap">${v.type}</span>` : ''}
                            </div>
                            <div class="text-xs text-gray-400 font-mono mb-2 truncate">${v.read}</div>
                            <div class="mt-auto pt-2 border-t border-gray-50 text-sm font-bold text-${color}-600 leading-snug">${v.mean}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
           </div>`
        : `<div class="h-full flex flex-col items-center justify-center text-gray-300">
             <i class="fas fa-layer-group text-4xl mb-3 opacity-30"></i>
             <span class="text-sm font-medium">異붽? ?⑥뼱 ?놁쓬</span>
           </div>`;

    // ?욌㈃ HTML (?먮룞?ъ깮 踰꾪듉 ?쒓굅??
    const frontHTML = `
        <div class="absolute w-full h-full backface-hidden bg-white rounded-3xl border border-gray-200 shadow-sm flex flex-col justify-between overflow-hidden" id="card-front-${uniqueId}">
            <div class="px-5 py-4 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
                 <span class="px-3 py-1 rounded-full ${isQuestion? `bg-${color}-100 text-${color}-700` : 'bg-gray-200 text-gray-600'} text-[10px] font-black tracking-widest uppercase">
                    ${isQuestion? 'Question' : `Answer ${index + 1}`}
                 </span>
                <span class="text-[10px] text-gray-400 font-bold flex items-center gap-1 cursor-pointer" onclick="event.stopPropagation(); toggleCardFlip('${uniqueId}')">
                    <i class="fas fa-sync-alt"></i> FLIP
                </span>
            </div>
            <div class="flex-1 flex flex-col justify-center px-5 space-y-4">
                <div class="text-2xl md:text-3xl font-black text-gray-800 leading-snug text-center break-keep select-none">${data.jp}</div>
                <div class="text-xs md:text-sm text-gray-400 font-medium text-center font-mono select-none">${data.romaji}</div>
                <div class="w-8 h-1 bg-${color}-100 mx-auto rounded-full"></div>
                <div class="text-lg md:text-xl text-${color}-600 font-bold text-center break-keep select-none">${data.kr}</div>
            </div>
            <div class="px-4 py-3 bg-gray-50 border-t border-gray-100 flex gap-2 justify-center" onclick="event.stopPropagation()">
                <button onclick="AudioController.playNormal(this.dataset.text)" data-text="${data.jp.replace(/"/g, '&quot;')}" class="flex-1 py-2 rounded-xl bg-white border border-gray-200 text-gray-600 font-bold hover:bg-${color}-50 hover:text-${color}-600 text-xs flex flex-col items-center justify-center gap-1 active:scale-95 transition-transform"><i class="fas fa-volume-up"></i>?ｊ린</button>
                <button onclick="AudioController.playSlowRepeat(this.dataset.text)" data-text="${data.jp.replace(/"/g, '&quot;')}" class="flex-1 py-2 rounded-xl bg-white border border-gray-200 text-gray-600 font-bold hover:bg-${color}-50 hover:text-${color}-600 text-xs flex flex-col items-center justify-center gap-1 active:scale-95 transition-transform"><i class="fas fa-history"></i>3??/button>
                <button onclick="AudioController.playShadowing(this.dataset.text)" data-text="${data.jp.replace(/"/g, '&quot;')}" class="flex-1 py-2 rounded-xl bg-white border border-gray-200 text-gray-600 font-bold hover:bg-${color}-50 hover:text-${color}-600 text-xs flex flex-col items-center justify-center gap-1 active:scale-95 transition-transform"><i class="fas fa-microphone-alt"></i>?먮룄??/button>
            </div>
        </div>`;

    const backHTML = `
        <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-slate-50 rounded-3xl border-2 border-${color}-100 shadow-inner flex flex-col overflow-hidden">
             <div class="flex-1 p-4 overflow-hidden relative">${vocabListHTML}</div>
             <div class="py-3 bg-white border-t border-gray-200 text-center cursor-pointer hover:bg-gray-50" onclick="event.stopPropagation(); toggleCardFlip('${uniqueId}')">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-widest flex items-center justify-center gap-2"><i class="fas fa-undo"></i> Return</span>
             </div>
        </div>`;

    return `<div class="perspective-1000 w-full mb-8 select-none group" onclick="toggleCardFlip('${uniqueId}')">
        <div id="${uniqueId}" class="card-inner relative w-full min-h-[450px] md:min-h-[500px] transform-style-3d shadow-lg rounded-3xl hover:shadow-xl transition-all duration-500 bg-white">${frontHTML}${backHTML}</div>
    </div>`;
}

function displayCurrentConversation() {
    const convData = conversationModuleData[currentConversationCategory];
    if (!convData) return;
    const currentConv = convData.conversations[currentConversationIndex];
    const viewer = document.getElementById('conversation-viewer');

    // ?먮룞?ъ깮 踰꾪듉 ?곹깭 ?뺤씤
    const autoPlayBtnState = AudioController.isAutoPlaying? 
        `<button id="global-auto-play-btn" onclick="AudioController.stopAutoRepeat()" class="btn-auto-active px-4 py-2 rounded-full font-bold text-sm shadow-md flex items-center gap-2 transition-all"><i class="fas fa-stop"></i>?뺤?</button>` :
        `<button id="global-auto-play-btn" onclick="startCategoryAutoPlay()" class="bg-white border border-gray-200 text-gray-600 hover:text-${convData.color}-600 hover:border-${convData.color}-200 px-4 py-2 rounded-full font-bold text-sm shadow-sm flex items-center gap-2 transition-all active:scale-95"><i class="fas fa-play-circle"></i>?꾩껜 ?먮룞?ъ깮</button>`;

    viewer.innerHTML = `
        <div class="flex items-center justify-between mb-6 px-1">
            <h3 class="text-lg md:text-xl font-bold text-gray-800 flex items-center gap-2">
                <span class="w-1.5 h-6 bg-${convData.color}-500 rounded-full inline-block"></span>
                <span class="truncate max-w-[150px] md:max-w-none">${convData.title}</span>
                <span class="text-sm text-gray-400 font-normal ml-1">(${currentConversationIndex + 1}/${convData.conversations.length})</span>
            </h3>
            <div class="flex gap-2 items-center">
                ${autoPlayBtnState}
            </div>
        </div>
        
        <div class="flex justify-between items-center mb-4 px-2">
             <button id="conv-prev-btn" onclick="previousConversation()" class="w-10 h-10 rounded-full bg-white border border-gray-200 shadow text-gray-400 hover:text-gray-800 flex items-center justify-center active:scale-90 transition-transform"><i class="fas fa-arrow-left"></i></button>
             <div class="text-xs text-gray-300 font-medium tracking-widest">SWIPE OR CLICK</div>
             <button id="conv-next-btn" onclick="nextConversation()" class="w-10 h-10 rounded-full bg-black shadow-lg text-white hover:bg-gray-800 flex items-center justify-center active:scale-90 transition-transform"><i class="fas fa-arrow-right"></i></button>
        </div>

        <div class="space-y-6 animate-fade-in pb-20">
            ${createFlipCardHTML(currentConv.question, 'question', 0, convData.color)}
            <div class="relative pl-4 border-l-2 border-dashed border-gray-200 space-y-8">
                ${currentConv.answers.map((ans, idx) => createFlipCardHTML(ans, 'answer', idx, convData.color)).join('')}
            </div>
        </div>`;
    updateNavigationButtons();
}

function toggleCardFlip(id) { 
    const card = document.getElementById(id);
    if(card) card.parentElement.classList.toggle('card-flipped'); 
}

// ==========================================
// 4. 怨좉툒 ?ㅻ뵒??而⑦듃濡ㅻ윭 (?먮룞?ъ깮 濡쒖쭅 ?섏젙??
// ==========================================
const AudioController = {
    speechSynth: window.speechSynthesis,
    isAutoPlaying: false,

    speak: function (text, lang = 'ja-JP', rate = 1.0) {
        return new Promise((resolve) => {
            if (this.speechSynth.speaking) this.speechSynth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang; 
            utterance.rate = rate;
            const voices = this.speechSynth.getVoices();
            let voice;
            if (lang === 'ja-JP') voice = voices.find(v => v.lang === 'ja-JP') |

| voices.find(v => v.lang.includes('ja'));
            if (lang === 'ko-KR') voice = voices.find(v => v.lang === 'ko-KR') |

| voices.find(v => v.lang.includes('ko'));
            if(voice) utterance.voice = voice;
            
            utterance.onend = resolve; 
            utterance.onerror = resolve;
            this.speechSynth.speak(utterance);
        });
    },

    wait: ms => new Promise(r => setTimeout(r, ms)),

    playNormal: async function(t) { this.speechSynth.cancel(); await this.speak(t, 'ja-JP', 1.0); },
    playSlowRepeat: async function(t) { this.speechSynth.cancel(); for(let i=0;i<3;i++){ await this.speak(t,'ja-JP',0.7); await this.wait(600); } },
    playShadowing: async function(t) { this.speechSynth.cancel(); await this.speak(t,'ja-JP',0.7); await this.wait(1500); await this.speak(t,'ja-JP',1.0); },

    // [?듭떖] ?먮룞?ъ깮 濡쒖쭅: (JP 1??-> KR 1.2諛곗냽 1??-> ?湲? x 3??諛섎났
    playSentenceLoop: async function(jpText, krText) {
        for(let i=0; i<3; i++) {
            if(!this.isAutoPlaying) return false;
            
            // 1. ?쇰낯??1??
            await this.speak(jpText, 'ja-JP', 1.0);
            if(!this.isAutoPlaying) return false;
            await this.wait(300); 

            // 2. ?쒓뎅??鍮좊Ⅴ寃?1??
            await this.speak(krText, 'ko-KR', 1.2); 
            if(!this.isAutoPlaying) return false;
            
            // 3. ?곕씪???쒓컙 (?먮룄?????
            await this.wait(1500); 
        }
        return true;
    },

    stopAutoRepeat: function() {
        this.isAutoPlaying = false;
        this.speechSynth.cancel();
        const btn = document.getElementById('global-auto-play-btn');
        if(btn) {
            btn.className = "bg-white border border-gray-200 text-gray-600 hover:text-blue-600 px-4 py-2 rounded-full font-bold text-sm shadow-sm flex items-center gap-2 transition-all active:scale-95";
            btn.innerHTML = '<i class="fas fa-play-circle"></i>?꾩껜 ?먮룞?ъ깮';
            btn.onclick = startCategoryAutoPlay;
        }
        // ?섏씠?쇱씠???쒓굅
        document.querySelectorAll('.playing-highlight').forEach(el => el.classList.remove('playing-highlight'));
    }
};

// ?꾩껜 移댄뀒怨좊━ ?먮룞?ъ깮 ?쒖옉 ?⑥닔
async function startCategoryAutoPlay() {
    if (AudioController.isAutoPlaying) return;
    AudioController.isAutoPlaying = true;

    // 踰꾪듉 ?곹깭 蹂寃?
    const btn = document.getElementById('global-auto-play-btn');
    if(btn) {
        btn.className = "btn-auto-active px-4 py-2 rounded-full font-bold text-sm shadow-md flex items-center gap-2 transition-all";
        btn.innerHTML = '<i class="fas fa-stop"></i>?뺤?';
        btn.onclick = AudioController.stopAutoRepeat;
    }

    const convData = conversationModuleData[currentConversationCategory];
    
    // ?꾩옱 ?몃뜳?ㅻ????쒖옉
    for (let i = currentConversationIndex; i < convData.conversations.length; i++) {
        if (!AudioController.isAutoPlaying) break;

        // ?붾㈃ ?대룞 (?ㅽ겕濡?
        if (i!== currentConversationIndex) {
            currentConversationIndex = i;
            displayCurrentConversation();
            // 踰꾪듉 ?곹깭 ?ъ쟻??(?붾㈃ 媛깆떊?섎?濡?
            const newBtn = document.getElementById('global-auto-play-btn');
            if(newBtn) {
                newBtn.className = "btn-auto-active px-4 py-2 rounded-full font-bold text-sm shadow-md flex items-center gap-2 transition-all";
                newBtn.innerHTML = '<i class="fas fa-stop"></i>?뺤?';
                newBtn.onclick = AudioController.stopAutoRepeat;
            }
        }

        const conv = convData.conversations[i];

        // 1. 吏덈Ц ?ъ깮
        const qCard = document.getElementById('card-front-card-q');
        if(qCard) qCard.classList.add('playing-highlight');
        
        const qContinued = await AudioController.playSentenceLoop(conv.question.jp, conv.question.kr);
        if(qCard) qCard.classList.remove('playing-highlight');
        if (!qContinued) break;

        // 2. ?듬????쒖감 ?ъ깮
        for (let j = 0; j < conv.answers.length; j++) {
            if (!AudioController.isAutoPlaying) break;
            
            // ?듬? 移대뱶濡??ㅽ겕濡?
            const aCard = document.getElementById(`card-front-card-a-${j}`);
            if(aCard) {
                aCard.scrollIntoView({ behavior: "smooth", block: "center" });
                aCard.classList.add('playing-highlight');
            }

            const aContinued = await AudioController.playSentenceLoop(conv.answers[j].jp, conv.answers[j].kr);
            if(aCard) aCard.classList.remove('playing-highlight');
            if (!aContinued) break;
        }
        
        await AudioController.wait(1000); // ?ㅼ쓬 ??붾줈 ?섏뼱媛湲????湲?
    }

    AudioController.stopAutoRepeat();
}

function updateNavigationButtons() {
    const conv = conversationModuleData[currentConversationCategory];
    const prev = document.getElementById('conv-prev-btn');
    const next = document.getElementById('conv-next-btn');
    if(prev) { prev.disabled = currentConversationIndex===0; prev.style.opacity = currentConversationIndex===0?'0.3':'1'; }
    if(next) { 
        const isLast = currentConversationIndex === conv.conversations.length - 1;
        next.disabled = isLast; 
        next.style.opacity = isLast? '0.3' : '1';
    }
}

function previousConversation() { 
    AudioController.stopAutoRepeat(); 
    if(currentConversationIndex > 0) { 
        currentConversationIndex--; 
        displayCurrentConversation(); 
        window.scrollTo({top: 0, behavior: 'smooth'}); 
    } 
}

function nextConversation() { 
    AudioController.stopAutoRepeat(); 
    if(currentConversationIndex < conversationModuleData[currentConversationCategory].conversations.length - 1) { 
        currentConversationIndex++; 
        displayCurrentConversation(); 
        window.scrollTo({top: 0, behavior: 'smooth'}); 
    } 
}

document.addEventListener('DOMContentLoaded', () => { 
    if(document.getElementById('conversation-content')) initConversation(); 
});
